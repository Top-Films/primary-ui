version: '2.1'

executors:
  node:
    docker:
      - image: cimg/node:20.12.0
        auth:
          username: $DOCKER_USERNAME
          password: $DOCKER_PASSWORD
    working_directory: ~/app
    environment:
      APP_NAME: primary-ui
      APP_VERSION: 1.0.0

  base:
    docker:
      - image: cimg/base:2024.02
        auth:
          username: $DOCKER_USERNAME
          password: $DOCKER_PASSWORD
    working_directory: ~/app
    environment:
      ORG_NAME: topfilms
      APP_NAME: primary-ui
      APP_VERSION: 1.0.0

orbs:
  node: circleci/node@5.2.0
  docker: circleci/docker@2.6.0

jobs:
  react_test_build:
    executor: node

    steps:
      - checkout

      - node/install-packages:
          pkg-manager: 'npm'

      - run:
          name: Run tests
          command: npm run test

      - run:
          name: Build
          command: npm run build

      - persist_to_workspace:
          root: dist
          paths: '*'

      - store_artifacts:
          path: dist
          destination: $APP_NAME-$APP_VERSION

  docker_artifact_build_push:
    executor: base

    steps:
      - attach_workspace:
          at: ~/app/dist
      
      - docker/build:
          image: $DOCKER_USERNAME/$ORG_NAME-$APP_NAME:$APP_VERSION
          extra_build_args: --platform linux/arm64/v8

      - docker/push:
          image: $DOCKER_USERNAME/$ORG_NAME-$APP_NAME:$APP_VERSION

workflows:
  deployment:
    jobs:
      - react_test_build:
          context:
            - secrets
      - docker_artifact_build_push:
          context:
            - secrets
          requires:
            - react_test_build
